# ServeReedley — Project architecture and context

## Repository overview

**Purpose:** ServeReedley is a Community Resource Network (CRN) web application that helps coordinate community assistance for people in need. The application allows users to submit requests for help, and coordinators to manage and fulfill those needs.

**Type:** AWS Amplify full-stack application  
**Size:** ~767MB (including node_modules)  
**Primary tech stack:**
- **Frontend:** React 18.3.1 with TypeScript, Vite 5.3.3, Material-UI (MUI) v5
- **Backend:** AWS Amplify with AppSync (GraphQL API), Cognito (Auth), Lambda functions
- **Build tool:** Vite (replaced Create React App)
- **Test framework:** Vitest 2.0.4 with jsdom
- **Styling:** Material-UI, Emotion, custom theme
- **Internationalization:** i18next (English and Spanish support)
- **Node version:** v22
- **NPM version:** 10.8.2

## Critical build requirements

### AWS Amplify configuration dependency

The build process requires `src/aws-exports.js`, which is generated by AWS Amplify CLI and is gitignored. This file contains AWS resource configurations (AppSync endpoint, Cognito pool IDs, etc.).

**Build will fail with:** `Could not resolve "./aws-exports" from "src/ReportForm.tsx"` if this file is missing.

**Two files import aws-exports:**
- `src/ReportForm.tsx` (line 9)
- `src/NeedRequestTable.tsx` (line 42)

**Workaround for local development without AWS credentials:**  
Create a mock `src/aws-exports.js` file with the following structure:

```javascript
/* eslint-disable */
const awsmobile = {
    "aws_project_region": "us-west-1",
    "aws_appsync_graphqlEndpoint": "https://example.appsync-api.us-west-1.amazonaws.com/graphql",
    "aws_appsync_region": "us-west-1",
    "aws_appsync_authenticationType": "API_KEY",
    "aws_appsync_apiKey": "da2-fakeApiKey123456",
    "aws_cognito_identity_pool_id": "us-west-1:fake-pool-id",
    "aws_cognito_region": "us-west-1",
    "aws_user_pools_id": "us-west-1_fakePoolId",
    "aws_user_pools_web_client_id": "fake-client-id",
    "oauth": {}
};
export default awsmobile;
```

This mock allows builds but will not connect to real AWS services. For actual deployment, use `amplify pull` to generate the real configuration.

## Build and test commands

### Installation
```bash
npm install
```
**Time:** ~45–60 seconds. Always run this first in a fresh clone. May show 2 moderate severity vulnerabilities (expected).

### Development server
```bash
npm start
```
Runs `vite`. Port: http://localhost:3000. Hot-reloading enabled. Requires `src/aws-exports.js` to exist.

### Build for production
```bash
npm run build
```
Runs `vite build`. Time: ~15–20 seconds. Output: `dist/` directory. Requires `src/aws-exports.js`. May show chunk size warning (expected). Bundle ~2.3MB JS (gzipped ~645KB).

### Run tests
```bash
npm test
```
Runs `vitest`. Time: ~2–3 seconds. Current status: 4 tests pass (App.test.tsx, TeamList.test.tsx). Uses jsdom; setup: `src/setupTests.ts`. Watch mode by default. React Router future flag warnings are non-blocking.

### Linting and TypeScript
- **ESLint:** Inline in `package.json` (extends `react-app`, `react-app/jest`). No separate lint command; runs during build. See `.eslintignore`.
- **TypeScript:** `tsconfig.json` (target ES2020, strict). Type checking during build; no separate `tsc` script.

## Directory structure

```
/
├── .github/                    # GitHub configuration, workflows
├── .vscode/                    # VS Code settings (format on save)
├── amplify/                    # AWS Amplify backend
│   ├── backend/
│   │   ├── api/crn/            # AppSync GraphQL API
│   │   │   └── schema.graphql  # GraphQL schema
│   │   ├── auth/               # Cognito (crnAuth, userPoolGroups)
│   │   └── function/           # Lambda functions (6)
│   │       ├── NotifyCoordinators/
│   │       ├── NotifyTeamOnRequest/
│   │       ├── findlatlong/
│   │       ├── getUserContactInfo/
│   │       ├── listPeopleOnTeam/
│   │       └── sendReminders/
│   ├── .config/project-config.json
│   └── cli.json
├── docs/                       # Agent and project documentation
├── public/                     # Static assets
├── src/                        # React TypeScript source
│   ├── graphql/                # Auto-generated GraphQL
│   ├── data/                    # Static data (areasOfConcern.json)
│   ├── en.json, es.json        # i18n
│   └── [.tsx/.ts components and utilities]
├── mapdata/                    # KML geographical data
├── index.html, package.json, vite.config.ts, vitest.config.ts, tsconfig.json
└── .graphqlconfig.yml          # GraphQL codegen
```

## Key source files

- **Entry:** `src/index.tsx` → renders `<App />` into `#root`
- **App:** `src/App.tsx` — routes: `/` (redirect), `/request-need`, `/need-submitted`, `/requests` (auth), `/reports` (auth), `/teams` (auth), `/team`
- **Core components:** `needRequestForm.tsx`, `NeedRequestTable.tsx`, `ReportForm.tsx`, `TeamPicker.tsx`, `TeamManagementForm.tsx`, `UpdateRequestDialog.tsx`
- **Data:** `API.ts` (generated), `RequestAPI.ts`, `needRequestTypes.ts`
- **Utilities:** `theme.ts`, `i18n.ts`, `useRequestCounts.ts`, `useRequestsById.ts`, `useTeams.ts`

## GraphQL API

- **Schema:** `amplify/backend/api/crn/schema.graphql`
- **Generated types:** `src/API.ts` (do not edit)
- **Generated operations:** `src/graphql/{queries,mutations,subscriptions}.ts`
- **Models:** Request, NoteType, SelfOrOtherInfo, FoodInfo, MovingInfo, HomeRepairType, HouseholdItems, Team, TeamMember, TeamRequest
- **Auth:** API_KEY (public), AMAZON_COGNITO_USER_POOLS (coordinators)

## Lambda functions

Each has its own `package.json` in `amplify/backend/function/<name>/src/`. Run `npm install` in that `src/` when changing code or dependencies.

1. **getUserContactInfo** — User contact info (axios)
2. **listPeopleOnTeam** — Team members
3. **NotifyTeamOnRequest** — Notifications when requests assigned
4. **NotifyCoordinators** — New request alerts
5. **sendReminders** — Scheduled reminder emails
6. **findlatlong** — Geocoding

## Environment

- `.env.development` → `VITE_FUNCTION_ENV=dev`
- `.env.production` → `VITE_FUNCTION_ENV=prod`  
Vite loads by mode.

## CI/CD

- **GitHub Actions:** `.github/workflows/test.yml` runs unit tests on pull requests to `main` and `production` (creates mock `src/aws-exports.js`, uses Node 22, `npm ci`, `npm test -- --run`).
- **Amplify Console:** Pushes to GitHub trigger the frontend build in AWS Amplify.

## Do-not-edit list

**Auto-generated (do not edit):**
- `src/API.ts` — regenerated by `amplify push` (codegen output; see `.graphqlconfig.yml`)
- `src/graphql/*.ts` — regenerated by Amplify codegen
- `src/aws-exports.js` — from `amplify pull` if present
- `amplify/backend/amplify-meta.json`
- `amplify/#current-cloud-backend/`

**RequestAPI.ts:** If your codegen also generates `src/RequestAPI.ts`, do not edit it. If it is hand-maintained (re-exports or wrappers around API.ts), it is editable; app code imports types/operations from it. When in doubt, treat as generated until confirmed otherwise.

**Preserve:** `.graphqlconfig.yml`, `amplify/backend/backend-config.json`, `amplify/backend/function/*/function-parameters.json`

## Testing guidelines

- Tests: `src/*.test.tsx` (App.test.tsx, TeamList.test.tsx, TeamPicker.test.tsx). Vitest + @testing-library/react, user-event, jest-dom.
- Follow patterns in those files. Mock Amplify when needed. Use Vitest globals from `vitest.config.ts`.

## Common issues

- **Build fails "Could not resolve './aws-exports'":** Create mock `src/aws-exports.js` (see above).
- **npm install vulnerabilities:** 2 moderate known; acceptable unless upgrading.
- **Large chunk warning:** Expected (MUI/AWS SDK); non-blocking.
- **React Router future flags in tests:** Non-blocking; address with React Router v7 upgrade.

## Validation and workflows

- **Pre-commit:** `npm install`, `npm test`, `npm run build` (with aws-exports).
- **GraphQL update:** See [docs/workflows/UPDATE_GRAPHQL_MODEL.md](workflows/UPDATE_GRAPHQL_MODEL.md).
- **New UX after a GraphQL model change:** Complete [UPDATE_GRAPHQL_MODEL.md](workflows/UPDATE_GRAPHQL_MODEL.md) (including codegen verification) first; then see [NEW_UX_WITH_GRAPHQL_MODEL.md](workflows/NEW_UX_WITH_GRAPHQL_MODEL.md) for where to add routes, components, and i18n.
- **Lambda change:** See [docs/workflows/CHANGE_LAMBDA.md](workflows/CHANGE_LAMBDA.md).

**Performance:** Install ~60s, build ~15–20s, test ~2–3s, dev server ~2–3s.
