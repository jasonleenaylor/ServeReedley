# Copilot Coding Agent Instructions for ServeReedley

## Repository Overview

**Purpose:** ServeReedley is a Community Resource Network (CRN) web application that helps coordinate community assistance for people in need. The application allows users to submit requests for help, and coordinators to manage and fulfill those needs.

**Type:** AWS Amplify full-stack application  
**Size:** ~767MB (including node_modules)  
**Primary Tech Stack:**
- **Frontend:** React 18.3.1 with TypeScript, Vite 5.3.3, Material-UI (MUI) v5
- **Backend:** AWS Amplify with AppSync (GraphQL API), Cognito (Auth), Lambda functions
- **Build Tool:** Vite (replaced Create React App)
- **Test Framework:** Vitest 2.0.4 with jsdom
- **Styling:** Material-UI, Emotion, custom theme
- **Internationalization:** i18next (English and Spanish support)
- **Node Version:** v22
- **NPM Version:** 10.8.2

## Critical Build Requirements

### AWS Amplify Configuration Dependency

**IMPORTANT:** The build process requires `src/aws-exports.js` which is generated by AWS Amplify CLI and is gitignored. This file contains AWS resource configurations (AppSync endpoint, Cognito pool IDs, etc.).

**Build will fail with:** `Could not resolve "./aws-exports" from "src/ReportForm.tsx"` if this file is missing.

**Two files import aws-exports:**
- `src/ReportForm.tsx` (line 9)
- `src/NeedRequestTable.tsx` (line 42)

**Workaround for local development without AWS credentials:**
Create a mock `src/aws-exports.js` file with the following structure:
```javascript
/* eslint-disable */
const awsmobile = {
    "aws_project_region": "us-west-1",
    "aws_appsync_graphqlEndpoint": "https://example.appsync-api.us-west-1.amazonaws.com/graphql",
    "aws_appsync_region": "us-west-1",
    "aws_appsync_authenticationType": "API_KEY",
    "aws_appsync_apiKey": "da2-fakeApiKey123456",
    "aws_cognito_identity_pool_id": "us-west-1:fake-pool-id",
    "aws_cognito_region": "us-west-1",
    "aws_user_pools_id": "us-west-1_fakePoolId",
    "aws_user_pools_web_client_id": "fake-client-id",
    "oauth": {}
};
export default awsmobile;
```

**Note:** This mock file allows builds but won't connect to real AWS services. For actual deployment, use `amplify pull` to generate the real configuration.

## Build and Test Commands

### Installation
```bash
npm install
```
**Time:** ~45-60 seconds  
**Notes:** Always run this first in a fresh clone. May show 2 moderate severity vulnerabilities (expected).

### Development Server
```bash
npm start
```
**Command:** Runs `vite`  
**Port:** http://localhost:3000  
**Notes:** Hot-reloading enabled. Requires `src/aws-exports.js` to exist.

### Build for Production
```bash
npm run build
```
**Command:** Runs `vite build`  
**Time:** ~15-20 seconds  
**Output:** `dist/` directory  
**Notes:** 
- Requires `src/aws-exports.js` to exist
- May show warning about chunk sizes >500KB (expected, can be ignored)
- Build produces ~2.3MB JavaScript bundle (gzipped to ~645KB)

### Run Tests
```bash
npm test
```
**Command:** Runs `vitest`  
**Time:** ~2-3 seconds  
**Current Status:** 4 tests pass (2 test files)
- `src/App.test.tsx` - 1 test
- `src/TeamList.test.tsx` - 3 tests

**Notes:** 
- Uses jsdom environment for DOM testing
- Setup file: `src/setupTests.ts`
- Tests run in watch mode by default
- May show React Router future flag warnings (non-blocking)

### Linting
**ESLint Configuration:** Defined inline in `package.json` (extends `react-app`, `react-app/jest`)  
**No separate lint command:** ESLint runs during build via Vite  
**Ignored files:** See `.eslintignore` (contains `amplify-codegen-temp\models\models`)

### TypeScript Type Checking
**Config:** `tsconfig.json` (target: ES2020, strict mode enabled)  
**Notes:** Type checking happens automatically during build. No separate `tsc` script.

## Project Architecture

### Directory Structure
```
/
├── .github/                    # GitHub configuration (workflows would go here)
├── .vscode/                    # VS Code settings (format on save enabled)
├── amplify/                    # AWS Amplify backend configuration
│   ├── backend/
│   │   ├── api/crn/            # AppSync GraphQL API
│   │   │   └── schema.graphql  # GraphQL schema (213 lines)
│   │   ├── auth/               # Cognito authentication
│   │   │   ├── crnAuth/        # User pool configuration
│   │   │   └── userPoolGroups/ # User group management
│   │   └── function/           # Lambda functions (6 total)
│   │       ├── NotifyCoordinators/
│   │       ├── NotifyTeamOnRequest/
│   │       ├── findlatlong/
│   │       ├── getUserContactInfo/
│   │       ├── listPeopleOnTeam/
│   │       └── sendReminders/
│   ├── .config/project-config.json  # Amplify project settings
│   └── cli.json                # Amplify CLI configuration
├── public/                     # Static assets (favicon, logos, manifest.json)
├── src/                        # React TypeScript source code
│   ├── graphql/                # Auto-generated GraphQL queries/mutations
│   ├── data/                   # Static data (areasOfConcern.json)
│   ├── en.json, es.json        # Internationalization files
│   └── [35 .tsx/.ts files]     # Components and utilities
├── mapdata/                    # KML files for geographical data
├── index.html                  # Vite entry HTML
├── package.json                # Node dependencies and scripts
├── vite.config.ts              # Vite build configuration
├── vitest.config.ts            # Vitest test configuration
├── tsconfig.json               # TypeScript configuration
└── .graphqlconfig.yml          # GraphQL code generation config
```

### Key Source Files
**Entry Point:** `src/index.tsx` → renders `<App />` into `#root`

**Main Application:** `src/App.tsx` - Router setup with routes:
- `/` - Redirects to servereedley.org
- `/request-need` - Public need request form
- `/need-submitted` - Confirmation page
- `/requests` - Coordinator request management table (requires auth)
- `/reports` - Reporting interface (requires auth)
- `/teams` - Team management (requires auth)
- `/team` - Team selection

**Core Components:**
- `needRequestForm.tsx` - Main public-facing form for submitting help requests
- `NeedRequestTable.tsx` - Coordinator view of all requests with filtering/editing
- `ReportForm.tsx` - Reporting dashboard (uses aws-exports)
- `TeamPicker.tsx`, `TeamManagementForm.tsx` - Team coordination
- `UpdateRequestDialog.tsx` - Modal for updating request status

**Data Models:**
- `API.ts` - Auto-generated GraphQL TypeScript types (247KB)
- `RequestAPI.ts` - GraphQL operations and custom types (247KB)
- `needRequestTypes.ts` - TypeScript interfaces for needs/requests

**Utilities:**
- `theme.ts` - Material-UI theme configuration (yellow/grey palette)
- `i18n.ts` - i18next internationalization setup
- `useRequestCounts.ts`, `useRequestsById.ts`, `useTeams.ts` - Custom React hooks

### GraphQL API Configuration
**Schema Location:** `amplify/backend/api/crn/schema.graphql`  
**Generated Types:** `src/API.ts` (auto-generated, don't edit manually)  
**Generated Operations:** `src/graphql/{queries,mutations,subscriptions}.ts`

**Main Models:**
- `Request` - Need requests with status tracking
- `NoteType` - Notes on requests
- `FoodInfo`, `MovingInfo`, `HomeRepairType`, `HouseholdItems` - Specialized request types
- `Team`, `TeamPeople` - Team coordination models

**Authentication:** API_KEY (public) and AMAZON_COGNITO_USER_POOLS (coordinators)

### Lambda Functions
Each function is Node.js-based with its own `package.json` in `amplify/backend/function/<name>/src/`:

1. **getUserContactInfo** - Fetches user contact info from external API (uses axios)
2. **listPeopleOnTeam** - Lists team members
3. **NotifyTeamOnRequest** - Sends notifications when requests are assigned
4. **NotifyCoordinators** - Alerts coordinators of new requests
5. **sendReminders** - Scheduled reminder emails
6. **findlatlong** - Geocoding service for addresses

**Important:** Lambda functions have their own dependencies. If modifying Lambda code, run `npm install` in the function's `src/` directory.

### Environment Configuration
**Development:** `.env.development` sets `VITE_FUNCTION_ENV=dev`  
**Production:** `.env.production` sets `VITE_FUNCTION_ENV=prod`  
Vite automatically loads the appropriate env file based on mode.

## Validation and CI/CD

**No GitHub Actions detected** - The repository doesn't currently have CI/CD workflows defined.

**Amplify Console Deployment:** Changes pushed to GitHub trigger frontend builds in AWS Amplify Console automatically.

**Pre-commit Validation Steps:**
1. Run `npm install` to ensure dependencies are current
2. Run `npm test` to verify all tests pass
3. Run `npm run build` to ensure production build succeeds (requires mock or real aws-exports.js)
4. Check TypeScript compilation (automatic during build)

## Updating the GraphQL API

**From README.md workflow:**
1. Pull latest: `amplify pull` (requires Amplify CLI and AWS credentials)
2. Edit: `amplify/backend/api/crn/schema.graphql`
3. Push changes: `amplify push` (regenerates `src/API.ts` and GraphQL files)
4. Update frontend code to use new model
5. Test all components that interact with the model
6. Commit frontend changes and push to GitHub (triggers Amplify build)

**Note:** Be careful adding data during testing that the published frontend doesn't yet support.

## Common Issues and Workarounds

### Issue: Build fails with "Could not resolve './aws-exports'"
**Cause:** Missing `src/aws-exports.js` (gitignored Amplify config file)  
**Solution:** Create mock aws-exports.js as shown in "Critical Build Requirements" section above

### Issue: npm install shows vulnerabilities
**Status:** 2 moderate vulnerabilities are currently known and acceptable  
**Action:** No immediate fix required unless upgrading dependencies

### Issue: Large chunk size warning during build
**Status:** Expected - bundle is ~2.3MB due to MUI and AWS SDK dependencies  
**Impact:** Non-blocking warning, can be ignored  
**Future Optimization:** Consider code-splitting with dynamic imports

### Issue: React Router future flag warnings during tests
**Status:** Expected - React Router v6 preparing for v7 changes  
**Impact:** Non-blocking, tests still pass  
**Action:** Can be addressed when upgrading to React Router v7

## Important Files to Avoid Editing

**Auto-generated (DO NOT EDIT):**
- `src/API.ts` - Regenerated by `amplify push`
- `src/graphql/*.ts` - Regenerated by Amplify codegen
- `src/aws-exports.js` - Generated by `amplify pull` (if it exists)
- `amplify/backend/amplify-meta.json` - Amplify state file
- `amplify/#current-cloud-backend/` - Cloud backend snapshot

**Configuration files to preserve:**
- `.graphqlconfig.yml` - GraphQL codegen settings
- `amplify/backend/backend-config.json` - Backend resource configuration
- All `amplify/backend/function/*/function-parameters.json` files

## Testing Guidelines

**Existing Tests:** Located in `src/*.test.tsx` files  
**Test Library:** @testing-library/react v13.4.0  
**Test Utilities:** @testing-library/user-event, @testing-library/jest-dom

**When adding new tests:**
- Follow existing patterns in `App.test.tsx` and `TeamList.test.tsx`
- Use Vitest globals (describe, it, expect) configured in `vitest.config.ts`
- Mock AWS Amplify calls when needed
- Tests should be fast (current suite runs in ~2 seconds)

## Additional Notes for Agents

**Trust These Instructions:** The information above has been validated by running commands and inspecting the codebase. Only search for additional information if:
- These instructions are incomplete for your specific task
- You encounter an error not documented here
- The repository structure has changed significantly

**Key Success Factors:**
1. Always ensure `src/aws-exports.js` exists before building (mock or real)
2. Run `npm install` in fresh environments before any other command
3. Test changes with `npm test` before committing
4. Verify builds succeed with `npm run build`
5. Be cautious with GraphQL schema changes - they affect the entire application
6. Lambda function changes require separate `npm install` in the function directory
7. Remember this is a TypeScript project - maintain type safety

**Performance Expectations:**
- Install: ~60 seconds
- Build: ~15-20 seconds
- Test: ~2-3 seconds
- Dev server startup: ~2-3 seconds

**Repository Characteristics:**
- Internationalized (English/Spanish)
- Authenticated routes require Cognito login
- Public routes allow anonymous need submissions
- Material-UI provides consistent styling
- Vite provides fast builds and HMR
