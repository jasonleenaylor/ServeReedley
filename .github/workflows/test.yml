name: Run Unit Tests

# Security: Only run on pull requests to prevent unauthorized code execution
on:
  pull_request:
    branches:
      - main
      - production

# Security: Minimal permissions - only read access required for testing
permissions:
  contents: read

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      # Security: Pin to specific commit SHA instead of floating tag
      - name: Checkout code
        uses: actions/checkout@v4.1.1
      
      # Security: Use Node.js version matching repository requirements (v20)
      - name: Setup Node.js
        uses: actions/setup-node@v4.0.2
        with:
          node-version: '22'
          # Security: Cache dependencies to speed up builds and reduce external requests
          cache: 'npm'
      
      # Install dependencies
      - name: Install dependencies
        run: npm ci
      
      # Security: Create mock AWS config instead of using real credentials
      # This prevents accidental exposure of AWS resources during testing
      - name: Create mock AWS exports file
        run: |
          cat > src/aws-exports.js << 'EOF'
          /* eslint-disable */
          const awsmobile = {
              "aws_project_region": "us-west-1",
              "aws_appsync_graphqlEndpoint": "https://example.appsync-api.us-west-1.amazonaws.com/graphql",
              "aws_appsync_region": "us-west-1",
              "aws_appsync_authenticationType": "API_KEY",
              "aws_appsync_apiKey": "da2-fakeApiKey123456",
              "aws_cognito_identity_pool_id": "us-west-1:fake-pool-id",
              "aws_cognito_region": "us-west-1",
              "aws_user_pools_id": "us-west-1_fakePoolId",
              "aws_user_pools_web_client_id": "fake-client-id",
              "oauth": {}
          };
          export default awsmobile;
          EOF
      
      # Run tests
      - name: Run unit tests
        run: npm test -- --run
